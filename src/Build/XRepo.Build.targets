<Project ToolsVersion="15.0">
  <UsingTask TaskName="XRepo.Build.Tasks.ResolvePackageReferences"
			   AssemblyFile="$(MSBuildThisFileDirectory)\XRepo.Build.dll"/>
  <UsingTask TaskName="XRepo.Build.Tasks.RegisterPackage"
			   AssemblyFile="$(MSBuildThisFileDirectory)\XRepo.Build.dll"/>
  <UsingTask TaskName="XRepo.Build.Tasks.ResolvePackageSources"
             AssemblyFile="$(MSBuildThisFileDirectory)\XRepo.Build.dll"/>
  <UsingTask TaskName="XRepo.Build.Tasks.OverridePinnedDependencyLocations"
             AssemblyFile="$(MSBuildThisFileDirectory)\XRepo.Build.dll"/>

  <Target Name="_XRepoRegisterPackageOnPack" AfterTargets="Pack">
    <CallTarget Condition="$(IsPackable.ToLower())!='false'" Targets="_XRepoRegisterPackage" />
  </Target>

  <Target Name="_XRepoRegisterPackageOnBuild" AfterTargets="Build">
    <CallTarget Condition="$(GeneratePackageOnBuild.ToLower())=='true'" Targets="_XRepoRegisterPackage" />
  </Target>
  
  <Target Name="_XRepoRegisterPackage">
    <XRepo.Build.Tasks.RegisterPackage
      PackageOutputPath="$(PackageOutputPath)"
      PackageId="$(PackageId)"
      PackageVersion="$(PackageVersion)"
      ProjectPath="$(MSBuildProjectFullPath)"
      CustomConfigDir="$(XRepoConfigDir)"
      Condition="$(PackageOutputPath)!=''"
      XRepoDebug="$(XRepoDebug)"
      DebugTask="false"/>
  </Target>

  <Target Name="_XRepoOverrideReferenceLocations" AfterTargets="_ComputeLockFileReferences">
    <XRepo.Build.Tasks.OverridePinnedDependencyLocations
      CompileFileDefinitions="@(ResolvedCompileFileDefinitions)"
      XRepoDebug="$(XRepoDebug)">
      <Output TaskParameter="OverriddenDefinitions" ItemName="OverriddenCompileFileDefinitions" />
      <Output TaskParameter="PinnedDefinitions" ItemName="PinnedCompileFileDefinitions" />
    </XRepo.Build.Tasks.OverridePinnedDependencyLocations>
    
    <ItemGroup>
      <ResolvedCompileFileDefinitions Remove="@(OverriddenCompileFileDefinitions)" />
      <ResolvedCompileFileDefinitions Include="@(PinnedCompileFileDefinitions)" />
    </ItemGroup>
  </Target>
  
</Project>